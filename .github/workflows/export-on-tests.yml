name: Export after tests

permissions:
  contents: write

on:
  workflow_run:
    workflows: ["Test"]
    types:
      - completed
    branches: [ master ]
  workflow_dispatch:

jobs:
  run-export:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        extensions: mbstring

    - name: Install Composer
      run: |
        php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
        php composer-setup.php --quiet
        php -r "unlink('composer-setup.php');"
        php composer.phar --version

    - name: Install dependencies
      run: php composer.phar install --no-interaction --no-progress --prefer-dist

    - name: Run export script
      run: php export.php

    - name: Check for changes
      id: git-check
      run: |
        set -o pipefail
        git status --porcelain > changes.txt
        if [ -s changes.txt ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
        else
          echo "changed=false" >> $GITHUB_OUTPUT
        fi

    - name: Commit and push changes
      if: steps.git-check.outputs.changed == 'true'
      env:
        GIT_AUTHOR_NAME: github-actions
        GIT_AUTHOR_EMAIL: github-actions@github.com
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        REPOSITORY: ${{ github.repository }}
        BRANCH: ${{ github.ref_name }}
      run: |
        git config user.name "$GIT_AUTHOR_NAME"
        git config user.email "$GIT_AUTHOR_EMAIL"
        git add -A
        git commit -m "Run export.php â€” update exported data [skip ci]" || echo "No commit created"
        git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${REPOSITORY}.git
        git push origin HEAD:${BRANCH}
